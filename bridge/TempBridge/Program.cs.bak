using System;
using Newtonsoft.Json;
using LibreHardwareMonitor.Hardware;

namespace TempBridge
{
    public class TemperatureData
    {
        public int CpuTemp { get; set; }
        public int GpuTemp { get; set; }
        public int MaxTemp { get; set; }
        public long UpdateTime { get; set; }
        public bool Success { get; set; }
        public string Error { get; set; }

        public TemperatureData()
        {
            Error = string.Empty;
        }
    }

    public class UpdateVisitor : IVisitor
    {
        public void VisitComputer(IComputer computer)
        {
            computer.Traverse(this);
        }

        public void VisitHardware(IHardware hardware)
        {
            hardware.Update();
            foreach (IHardware subHardware in hardware.SubHardware)
                subHardware.Accept(this);
        }

        public void VisitSensor(ISensor sensor) { }
        public void VisitParameter(IParameter parameter) { }
    }

    class Program
    {
        static void Main(string[] args)
        {
            var result = new TemperatureData
            {
                UpdateTime = DateTimeOffset.UtcNow.ToUnixTimeSeconds()
            };

            try
            {
                Computer computer = new Computer
                {
                    IsCpuEnabled = true,
                    IsGpuEnabled = true,
                    IsMemoryEnabled = false,
                    IsMotherboardEnabled = false,
                    IsControllerEnabled = false,
                    IsNetworkEnabled = false,
                    IsStorageEnabled = false
                };

                computer.Open();
                computer.Accept(new UpdateVisitor());

                int maxCpuTemp = 0;
                int maxGpuTemp = 0;

                foreach (IHardware hardware in computer.Hardware)
                {
                    if (hardware.HardwareType == HardwareType.Cpu)
                    {
                        foreach (ISensor sensor in hardware.Sensors)
                        {
                            if (sensor.SensorType == SensorType.Temperature && sensor.Value.HasValue)
                            {
                                int temp = (int)Math.Round(sensor.Value.Value);
                                if (temp > 0 && temp < 150) // 合理温度范围
                                {
                                    // 优先选择CPU Package温度
                                    if (sensor.Name.Contains("Package") || sensor.Name.Contains("CPU Package"))
                                    {
                                        maxCpuTemp = temp;
                                        break; // 找到Package温度就跳出，这是最准确的
                                    }
                                    // 如果没有Package温度，选择最高的Core温度
                                    else if (sensor.Name.Contains("Core") && temp > maxCpuTemp)
                                    {
                                        maxCpuTemp = temp;
                                    }
                                    // 其他CPU温度传感器作为备选
                                    else if (!sensor.Name.Contains("Core") && maxCpuTemp == 0)
                                    {
                                        maxCpuTemp = temp;
                                    }
                                }
                            }
                        }
                    }
                    else if (hardware.HardwareType == HardwareType.GpuNvidia || 
                             hardware.HardwareType == HardwareType.GpuAmd ||
                             hardware.HardwareType == HardwareType.GpuIntel)
                    {
                        foreach (ISensor sensor in hardware.Sensors)
                        {
                            if (sensor.SensorType == SensorType.Temperature && sensor.Value.HasValue)
                            {
                                int temp = (int)Math.Round(sensor.Value.Value);
                                if (temp > maxGpuTemp && temp < 150) // 合理温度范围
                                {
                                    maxGpuTemp = temp;
                                }
                            }
                        }
                    }
                }

                computer.Close();

                result.CpuTemp = maxCpuTemp;
                result.GpuTemp = maxGpuTemp;
                result.MaxTemp = Math.Max(maxCpuTemp, maxGpuTemp);
                result.Success = true;
            }
            catch (Exception ex)
            {
                result.Success = false;
                result.Error = ex.Message;
            }

            // 输出JSON格式的结果
            string json = JsonConvert.SerializeObject(result, new JsonSerializerSettings
            {
                ContractResolver = new Newtonsoft.Json.Serialization.CamelCasePropertyNamesContractResolver()
            });
            
            Console.WriteLine(json);
        }
    }
}
